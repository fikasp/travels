<!-- @r >> TRAVELS
-->
<!DOCTYPE html>
<html>
	<head>
		<title>Podróże</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<!-- favicon -->
		<link
			rel="icon"
			href="data:image/x-icon;base64,AAABAAEAEBAQAAEABAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAgAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAA/4QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEREREREREREREREREREREREAAAAAAAAREQAAAAAAABERAAAAAAAAEREAAAAAAAAREQAAAAAAABERAAAAAAAAEREAAAAAAAAREQAAAAAAABERAAAAAAAAEREAAAAAAAAREQAAAAAAABERAAAAAAAAEREREREREREREREREREREREAAAAAAAAAAD/8AAA//AAAP/wAAD/8AAA//AAAP/wAAD/8AAA//AAAP/wAAD/8AAA//AAAP/wAAAAAAAAAAAAA"
			type="image/png"
		/>
		<!-- font awesome -->
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
		/>
		<!-- leaflet -->
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.css"
		/>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.4.0/gpx.min.js"></script>
		<script src="routes.js"></script>
		<script src="index.js"></script>

		<!-- @r > STYLE 
  	-->
		<style>
			/* @r General 
				*/
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}
			* {
				scrollbar-width: thin;
				scrollbar-color: #222 #333;
			}
			*::-webkit-scrollbar {
				width: 10px;
			}
			*::-webkit-scrollbar-track {
				background-color: #333;
				border-radius: 20px;
			}
			*::-webkit-scrollbar-thumb {
				background-color: #222;
				border-radius: 20px;
			}
			html {
				color: #fff;
				background: #000;
				font-family: verdana, sans-serif;
				font-size: 14px;
				--accent: #4af;
				--viewHeight: 0px;
				--marginTop: 0px;
			}

			/* @r Header 
				*/
			.header {
				z-index: 2000;
				background-color: black;
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				padding: 5px 60px 5px 16px;
				min-height: 40px;
				display: flex;
				flex-wrap: wrap;
				align-items: center;
				justify-content: center;
				transition: transform 0.3s ease-out;
				box-shadow: 0 0 10px 0 black;
			}
			.header.hide {
				transform: translateY(-130%);
			}
			.header_pair {
				display: flex;
				padding: 5px 0px;
				flex-grow: 1;
			}
			@media (min-width: 1000px) {
				.header_pair {
					width: 33%;
				}
			}
			@media (min-width: 1900px) {
				.header_pair {
					width: auto;
				}
			}
			.header_label {
				text-align: right;
				width: 80px;
				padding: 5px;
			}
			.header_button {
				padding: 5px 10px;
				transition: color 0.2s;
				text-align: center;
				cursor: pointer;
			}
			.header_button:hover {
				color: gray;
			}
			.header_select {
				flex-grow: 1;
				text-align: left;
				font-family: verdana;
				padding: 4px;
				width: 160px;
				color: #fff;
				background: black;
				border-color: #333;
				border-radius: 2px;
				transition: 0.2s;
			}
			.header_select:focus {
				color: var(--accent);
			}
			.header_option {
				padding: 5px;
				background: black;
				color: white;
			}
			.header_bars {
				z-index: 3000;
				position: fixed;
				width: 30px;
				height: 30px;
				display: flex;
				justify-content: center;
				align-items: center;
				top: 10px;
				left: 10px;
				font-size: 20px;
				border-radius: 4px;
				background-color: rgb(0, 0, 0, 0.7);
				box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
				transition: 0.5s;
			}
			.header_bars:hover {
				background-color: rgb(0, 0, 0, 100%);
			}
			.header_emblem {
				z-index: 3000;
				position: fixed;
				height: 60px;
				top: 5px;
				right: 0px;
			}

			/* @r Footer 
				*/
			.footer {
				z-index: 3000;
				position: fixed;
				bottom: 0px;
				left: 0px;
				width: 100vw;
				display: flex;
				justify-content: space-between;
				align-items: center;
				background: transparent;
				transition: transform 0.3s ease-out;
				box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
				backdrop-filter: blur(5px);
			}
			.footer.hide {
				transform: translateY(+120%);
			}
			.footer_view select {
				color: black;
				font-size: 13px;
				padding: 6px 20px;
				border: none;
				outline: none;
				text-align: left;
				background: transparent;
				font-family: verdana;
				appearance: none;
				-webkit-appearance: none;
				-moz-appearance: none;
			}
			.footer_view select option {
				background: lightgray;
				color: black;
			}
			.footer_copyright {
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				font-size: 13px;
				text-align: center;
				pointer-events: none;
				color: black;
			}
			@media (max-width: 600px) {
				.footer_copyright {
					display: none;
				}
			}
			.footer_distance {
				padding: 7px 20px;
				background: transparent;
				color: black;
				text-align: center;
				font-size: 13px;
			}

			/* @r Gallery 
				*/
			.gallery {
				z-index: 1000;
				position: fixed;
				margin-top: 0;
				left: 0;
				top: 0;
				width: 100%;
				max-height: 100vh;
				overflow: auto;
				overflow-x: hidden;
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
				transition: 0.2s;
				padding-bottom: 3px;
				gap: 0 3px;
			}
			@media (max-width: 1280px) {
				.gallery.half {
					grid-template-columns: repeat(3, auto);
				}
			}
			@media (max-width: 1000px) {
				.gallery {
					grid-template-columns: repeat(4, auto);
				}
			}
			@media (max-width: 640px) {
				.gallery {
					grid-template-columns: repeat(3, auto);
				}
				.gallery.half {
					grid-template-columns: repeat(2, auto);
				}
			}
			@media (max-width: 300px) {
				.gallery.half {
					grid-template-columns: repeat(1, auto);
				}
			}
			.gallery_background {
				z-index: 900;
				position: fixed;
				left: 0;
				top: 0;
				width: 100%;
				height: 100vh;
				transition: 0.2s;
				box-shadow: 0 0 5px 0 black;
				background-color: rgb(0, 0, 0, 80%);
				backdrop-filter: blur(5px);
			}
			.gallery_background.half {
				width: 50%;
			}
			.gallery_box {
				position: relative;
			}
			.gallery_box:hover .gallery_text {
				opacity: 1;
			}
			.gallery_text {
				font-size: 11px;
				position: absolute;
				padding: 10px;
				width: 100%;
				text-align: center;
				text-shadow: 0 0 5px #000;
				bottom: 0px;
				transition: opacity 0.2s ease-out;
				opacity: 0;
			}
			@media (max-width: 1000px) {
				.gallery_text {
					font-size: 10px;
				}
			}
			.gallery img {
				width: 100%;
				aspect-ratio: 4/3;
				object-fit: cover;
				box-shadow: 0 0 5px 0 black;
			}
			.gallery.top {
				top: var(--marginTop);
				max-height: calc(100vh - var(--marginTop));
			}
			.gallery.half {
				width: 50%;
			}

			/* @r Photo 
				*/
			.photo {
				display: flex;
				justify-content: center;
				align-items: center;
				position: fixed;
				z-index: 4000;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background-color: rgba(0, 0, 0, 0.9);
			}
			.photo_arrow {
				z-index: 2;
				display: flex;
				align-items: center;
				position: absolute;
				font-size: 30px;
				text-shadow: 0 0 3px #000;
				color: #888;
				transition: 1s;
				z-index: 1;
			}
			.photo_arrow:hover {
				text-shadow: 0 0 20px var(--accent);
				color: white;
			}
			.photo_next {
				height: 100%;
				right: 8px;
				top: 0px;
				padding: 0 10px 0 90px;
			}
			.photo_previous {
				height: 100%;
				left: 8px;
				top: 0px;
				padding: 0 90px 0 10px;
			}
			.photo_close {
				padding: 0 6px;
				right: 10px;
				top: 10px;
				z-index: 100;
			}
			.photo_play {
				font-size: 24px;
				padding: 0 6px;
				left: 10px;
				top: 13px;
				z-index: 100;
			}
			.photo_pause {
				font-size: 24px;
				padding: 0 6px;
				left: 10px;
				top: 13px;
				z-index: 100;
			}
			.photo_group {
				display: flex;
				position: relative;
				max-width: calc(100vw - 100px);
				max-height: calc(100vh - 30px);
				min-width: 300px;
				min-height: 40px;
				object-fit: cover;
				box-shadow: 0 0 30px #111;
				transition: 0.3s;
			}
			.photo_image {
				position: relative;
				max-width: calc(100vw - 100px);
				max-height: calc(100vh - 30px);
				object-fit: cover;
				transition: 0.3s;
			}
			.photo_name {
				font-size: 1.2rem;
				position: absolute;
				text-align: center;
				width: 100%;
				left: 0px;
				bottom: 5px;
				padding: 5px 15px;
				text-shadow: 0 0 5px #000;
				color: #fff;
				z-index: 1;
			}
			@media (max-height: 600px) {
				.photo_group {
					max-height: 100vh;
				}
				.photo_image {
					max-height: 100vh;
				}
			}
			@media (max-width: 1200px) {
				.photo_group {
					max-width: 100vw;
				}
				.photo_image {
					max-width: 100vw;
				}
				.photo_name {
					position: fixed;
				}
			}

			/* @r Map 
				*/
			.map {
				width: 100%;
				height: 100%;
				min-height: 100vh;
				position: fixed;
			}

			.leaflet-control-zoom-in,
			.leaflet-control-zoom-out {
				display: none !important;
			}
			.leaflet-control-attribution {
				display: none;
			}
			.leaflet-popup-content-wrapper,
			.leaflet-popup-tip {
				opacity: 0.8;
				color: #fff;
				font-family: verdana;
				background-color: #222;
				transition: opacity 0.3s ease;
				border-radius: 6px;
			}

			/* @r Markers 
				*/
			.marker {
				box-shadow: 0px 0px 2px 1px #666;
				border: 1px solid gray;
				object-fit: cover;
				transition: all 0.5s;
			}
			.marker-p {
				border: 1px solid black;
			}
			.marker-g {
				border: 1px solid orange;
			}
			.marker-h {
				border: 1px solid red;
			}
			.marker-n {
				border: 1px solid darkviolet;
			}
			.marker-o {
				border: 1px solid blue;
			}
			.marker-s {
				border: 1px solid dodgerblue;
			}
			.marker-z {
				border: 1px solid green;
			}
			.marker-tooltip {
				color: #fff;
				background-color: #222;
				padding: 6px;
				font-family: Verdana;
				font-size: 11px;
				white-space: pre;
				text-align: center;
				transition: opacity 0.5s ease-in-out;
				box-shadow: 0px 0px 2px 1px #666;
				border: 1px solid #222;
			}
			.leaflet-tooltip-bottom:before {
				border-bottom-color: #222 !important;
			}

			/* @r Display 
				*/
			.none {
				display: none;
			}
			.show {
				animation: show 0.5s;
			}
			.hide {
				animation: hide 0.5s;
			}

			@keyframes show {
				from {
					opacity: 0;
				}
				to {
					opacity: 1;
				}
			}
			@keyframes hide {
				from {
					opacity: 1;
				}
				to {
					opacity: 0;
				}
			}
		</style>
	</head>

	<body>
		<!-- @p > HTML 
  	-->
		<!-- @p Header
  	-->
		<!-- Bar -->
		<div class="header_bars">
			<i class="fa-solid fa-bars"></i>
		</div>

		<div class="header hide">
			<!-- Emblem -->
			<img class="header_emblem" />
			<!-- Category -->
			<div class="header_pair">
				<label class="header_label" for="category">Foto:</label>
				<select class="header_select" id="category"></select>
			</div>
			<!-- Activity -->
			<div class="header_pair">
				<label class="header_label" for="activity">Trasy:</label>
				<select class="header_select" id="activity"></select>
			</div>
			<!-- Date -->
			<div class="header_pair">
				<label class="header_label" for="date">Data:</label>
				<select class="header_select" id="date"></select>
			</div>
			<!-- Range -->
			<div class="header_pair">
				<label class="header_label" for="range">Zakres:</label>
				<select class="header_select" id="range"></select>
			</div>
			<!-- Region -->
			<div class="header_pair">
				<label class="header_label" for="region" id="labelRegion"></label>
				<select class="header_select" id="region"></select>
			</div>
			<!-- City -->
			<div class="header_pair">
				<label class="header_label" for="city" id="labelCity"></label>
				<select class="header_select" id="city"></select>
			</div>
		</div>

		<!-- @p Footer
  	-->
		<div class="footer hide">
			<!-- View -->
			<div class="footer_view">
				<select class="footer_select" id="view"></select>
			</div>
			<!-- Distance -->
			<div class="footer_copyright">2025 © Przemysław Fikas</div>
			<!-- Distance -->
			<div class="footer_distance"></div>
		</div>

		<!-- @p Gallery
  	-->
		<div class="gallery none"></div>
		<div class="gallery_background none"></div>

		<!-- @p Photo 
 		-->
		<div class="photo none">
			<!-- arrow play -->
			<div class="photo_arrow photo_play">
				<i class="fa-solid fa-play"></i>
			</div>
			<!-- arrow pause -->
			<div class="photo_arrow photo_pause none">
				<i class="fa-solid fa-pause"></i>
			</div>
			<!-- arrow close -->
			<div class="photo_arrow photo_close">
				<i class="fa-solid fa-xmark"></i>
			</div>
			<!-- arrow previous -->
			<div class="photo_arrow photo_previous">
				<i class="fa-solid fa-angle-left"></i>
			</div>
			<!-- arrow next -->
			<div class="photo_arrow photo_next">
				<i class="fa-solid fa-angle-right"></i>
			</div>
			<!-- photo group-->
			<div class="photo_group">
				<!-- image -->
				<img class="photo_image" draggable="false" />
				<!-- name -->
				<div class="photo_name"></div>
			</div>
		</div>

		<!-- @p Map 
  	-->
		<div class="map" id="map"></div>

		<script>
			// @g > SCRIPTS

			// @b Enums
			const enums = {
				ALL: 'all',
				NONE: 'none',
				PLAN: 'plan',
				PROFILE: 'P',
				MAP: 'map',
				MAP_GALLERY: 'map&gallery',
				GALLERY: 'gallery',
				EMPTY: '',
			}

			const labels = {
				NONE: 'Brak',
				ALL: 'Wszystkie',
				PLAN: 'Planowane',
				MAP: '🗺️ Mapa',
				MAP_GALLERY: '🗺️🖼️ Mapa i galeria',
				GALLERY: '🖼️ Galeria',
				TOTAL: 'PEŁNY',
			}

			const categories = {
				none: '❌ Brak',
				all: '📷 Wszystkie',
				P: '👤 Profilowe',
				O: '📋 Ogólne',
				S: '⛪ Sakralne',
				H: '🏰 Historyczne',
				N: '🏙️ Nowoczesne',
				G: '🍽️ Gastronomiczne',
				Z: '🌳 Zielone',
			}

			const activities = {
				none: '❌ Brak',
				all: '🚩 Wszystkie',
				transport_car: '🚗 Samochodowe',
				cycling: '🚴 Rowerowe',
				walking: '🚶 Spacerowe',
				hiking: '🥾 Trekkingowe',
				downhill_skiing: '🎿 Narciarskie',
				transport_public: '🚌 Autokarowe',
				transport_train: '🚆 Kolejowe',
				transport_boat: '🛳️ Promowe',
			}

			const ranges = {
				MOUNTAINS: 'GÓRY',
				POLAND: 'POLSKA',
				WORLD: 'EUROPA',
				ROADS: 'DROGI',
			}

			const allowedCategoriesByRange = {
				[ranges.ROADS]: ['none'],
				[ranges.MOUNTAINS]: ['none', 'all', 'P', 'H', 'N', 'Z'],
				[ranges.POLAND]: ['none', 'all', 'P', 'O', 'S', 'H', 'N', 'G', 'Z'],
				[ranges.WORLD]: ['none', 'all', 'P', 'O', 'S', 'H', 'N', 'G', 'Z'],
				[enums.NONE]: ['none', 'all', 'P', 'O', 'S', 'H', 'N', 'G', 'Z'],
			}

			const allowedActivitiesByRange = {
				[ranges.ROADS]: ['none','all'],
				[ranges.MOUNTAINS]: ['none', 'all', 'hiking', 'downhill_skiing'],
				[ranges.WORLD]: [
					'none',
					'all',
					'transport_public',
					'walking',
					'transport_boat',
				],
				[ranges.POLAND]: [
					'none',
					'all',
					'transport_car',
					'cycling',
					'walking',
					'transport_public',
					'transport_train',
				],
				[enums.NONE]: [
					'none',
					'all',
					'transport_car',
					'cycling',
					'walking',
					'hiking',
					'downhill_skiing',
					'transport_public',
					'transport_train',
					'transport_boat',
				],
			}

			const startCity = 'KRAKÓW'
			const mapActive = true
			const YEAR = 2025

			// @b Globals
			let $map // leaflet map
			let $distanceControl = null // distance control
			let $activityControl = null // activity control
			let $marginTop = 0 // margin top
			// tables
			let $photos = [] // table of photos
			let $markers = [] // table of markers
			let $citiesArray = [] // table with prepared data
			let $filteredData = [] // table with filtered data
			let $routeLayers = [] // table with added polylines
			// filters
			let $viewMode = enums.MAP // state of view mode
			let $activityFilter = enums.ALL // state of activity filter
			let $categoryFilter = enums.NONE // state of category filter
			let $dateFilter = enums.ALL // state of data filter
			// flags
			let $isInitialRender = true // flag for initial render
			let $isHiglightActive = true // flag for marker higlight activ
			let $isGalleryAndMap = false // flag for gallery and map open
			let $isPhotoClicked = false // flag for photo clicked
			let $isPhotoLoading = false // flag for photo loading
			let $isPhotoOpen = false // flag for photo open
			let $isMenuOpen = false // flag for menu open
			// photo
			let $touchStartX // touch start position
			let $touchEndX // touch end position
			let $interval // interval for presentation
			let $index = 0 // index of photo

			// @b Handles
			//
			const $root = document.querySelector('html')
			// header
			const $headerDiv = document.querySelector('.header')
			const $headerEmblem = document.querySelector('.header_emblem')
			const $headerBars = document.querySelector('.header_bars')
			// footer
			const $footerDiv = document.querySelector('.footer')
			const $footerDistance = document.querySelector('.footer_distance')
			const $footerView = document.querySelector('.footer_view')
			// gallery
			const $gallery = document.querySelector('.gallery')
			const $galleryBackground = document.querySelector('.gallery_background')
			// photo
			const $photo = document.querySelector('.photo')
			const $photoGroup = document.querySelector('.photo_group')
			const $photoName = document.querySelector('.photo_name')
			const $photoImage = document.querySelector('.photo_image')
			const $photoPrevious = document.querySelector('.photo_previous')
			const $photoNext = document.querySelector('.photo_next')
			const $photoPause = document.querySelector('.photo_pause')
			const $photoPlay = document.querySelector('.photo_play')
			// selects
			const $labelCity = document.querySelector('#labelCity')
			const $labelRegion = document.querySelector('#labelRegion')
			const $selectCity = document.querySelector('#city')
			const $selectRegion = document.querySelector('#region')
			const $selectRange = document.querySelector('#range')
			const $selectViewMode = document.querySelector('#view')
			const $selectActivity = document.querySelector('#activity')
			const $selectCategory = document.querySelector('#category')
			const $selectDate = document.querySelector('#date')
			// mobile
			const $isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent)

			// @b Listeners
			//
			// window
			window.addEventListener('load', main)
			window.addEventListener('keyup', checkKeys)
			window.addEventListener('resize', changeMargin)
			window.addEventListener('wheel', checkWheel)
			// header
			$headerDiv.addEventListener('touchstart', touchstart)
			$headerDiv.addEventListener('touchmove', touchmove)
			$headerDiv.addEventListener('touchend', touchend)
			$headerBars.addEventListener('click', showHideMenu)
			$headerEmblem.addEventListener('click', showHideMenu)
			$selectCity.addEventListener('change', setCity)
			$selectRegion.addEventListener('change', setRegion)
			$selectRange.addEventListener('change', setRange)
			$selectViewMode.addEventListener('change', setViewMode)
			$selectActivity.addEventListener('change', setActivities)
			$selectCategory.addEventListener('change', setCategory)
			$selectDate.addEventListener('change', setDate)
			addListenersToSelects([
				$selectCity,
				$selectRegion,
				$selectRange,
				$selectViewMode,
				$selectActivity,
				$selectCategory,
				$selectDate,
			])
			// photo
			$photo.addEventListener('click', hidePhoto)
			$photo.addEventListener('touchstart', touchstart)
			$photo.addEventListener('touchmove', touchmove)
			$photo.addEventListener('touchend', touchend)
			$photoPlay.addEventListener('click', togglePresentation)
			$photoPause.addEventListener('click', togglePresentation)
			$photoPrevious.addEventListener('click', showPreviousPhoto)
			$photoNext.addEventListener('click', showNextPhoto)

			// @g Main
			function main() {
				console.log(data)
				console.log(routes)
				// console.log(mapRegions(data[$selectRange.value]))
				console.log('main()')
				changeMargin()
				prepareMap()
				prepareData()
				prepareDates()
				prepareViewModes()
				prepareRanges()
				prepareActivities()
				prepareCategories()
				prepareRoutes()
				setRange()
			}

			// @b check keys
			function checkKeys(e) {
				console.log(`checkKeys(${e.key})`)

				if (e.key === 'ArrowLeft') {
					showPreviousPhoto(e)
				}
				if (e.key === 'ArrowRight') {
					showNextPhoto(e)
				}
				if (e.key === 'Escape') {
					hidePhoto(e)
				}
				if (e.key === 'F2') {
					showHideMenu(e)
				}
				if (e.key === 'F9') {
					togglePresentation(e)
				}
			}

			// @b check wheel
			function checkWheel(e) {
				if ($isPhotoOpen) {
					if (e.deltaY > 0) {
						showNextPhoto(e)
					} else {
						showPreviousPhoto(e)
					}
				}
			}

			// @b check touch
			function touchstart(e) {
				$touchStartX = e.touches[0].pageX
				$touchStartY = e.touches[0].pageY
				$touchEndY = $touchStartY
				$touchEndX = $touchStartX
			}
			function touchmove(e) {
				$touchEndX = e.touches[0].pageX
				$touchEndY = e.touches[0].pageY
			}
			function touchend(e) {
				const deltaX = $touchEndX - $touchStartX
				const deltaY = $touchEndY - $touchStartY
				console.log('touchX:', deltaX)
				console.log('touchY:', deltaY)
				if (deltaY < -50 && $isMenuOpen) {
					showHideMenu()
				}
				if (deltaX > 50 && $isPhotoOpen) {
					showPreviousPhoto(e)
				} else if (deltaX < -50 && $isPhotoOpen) {
					showNextPhoto(e)
				}
			}

			// @b add selects listeners
			function addListenersToSelects(selectElements) {
				selectElements.forEach(($select) => {
					let startX = 0
					let startY = 0
					const threshold = 30

					// swipe
					$select.addEventListener(
						'touchstart',
						(e) => {
							e.stopPropagation()
							const touch = e.changedTouches[0]
							startX = touch.pageX
							startY = touch.pageY
						},
						{ passive: true }
					)

					$select.addEventListener(
						'touchend',
						(e) => {
							e.stopPropagation()
							const touch = e.changedTouches[0]
							const diffX = touch.pageX - startX
							const diffY = touch.pageY - startY

							if (
								Math.abs(diffX) > Math.abs(diffY) &&
								Math.abs(diffX) > threshold
							) {
								const options = $select.options
								let newIndex = $select.selectedIndex

								if (diffX > 0) {
									if (newIndex < options.length - 1) newIndex++
								} else {
									if (newIndex > 0) newIndex--
								}

								if (newIndex !== $select.selectedIndex) {
									$select.selectedIndex = newIndex
									$select.dispatchEvent(new Event('change'))
								}
							}
						},
						{ passive: true }
					)

					// scroll
					$select.addEventListener(
						'wheel',
						(e) => {
							e.preventDefault()
							e.stopPropagation()
							const options = $select.options
							let newIndex = $select.selectedIndex

							if (e.deltaY > 0) {
								// down
								if (newIndex < options.length - 1) newIndex++
							} else {
								// up
								if (newIndex > 0) newIndex--
							}

							if (newIndex !== $select.selectedIndex) {
								$select.selectedIndex = newIndex
								$select.dispatchEvent(new Event('change'))
							}
						},
						{ passive: false }
					)
				})
			}

			// @b change margin
			function changeMargin() {
				console.log(`changeMargin()`)
				const windowHeight = window.innerHeight
				const headerHeight = $headerDiv.offsetHeight
				const viewHeight = windowHeight - headerHeight
				$marginTop = headerHeight

				$root.style.setProperty('--viewHeight', `${viewHeight}px`)
				$root.style.setProperty('--marginTop', `${headerHeight}px`)
			}

			// @g Data
			//
			// @b prepare data
			function prepareData() {
				console.log('prepareData()')
				$citiesArray = []

				for (const range in data) {
					for (const region in data[range]) {
						for (const city in data[range][region]) {
							const cityObj = data[range][region][city]

							// gallery photos
							if (cityObj.gallery) {
								cityObj.gallery.forEach((item) => {
									//prepare path
									function preparePath() {
										const capitalizedCity = capitalizeName(city)

										// path for mountains
										if (range == ranges.MOUNTAINS) {
											return `Góry/${region}/${capitalizedCity}/Zdjęcia/${item.name}.jpg`

											// path for world
										} else if (range == ranges.WORLD) {
											return `Świat/${region}/${capitalizedCity}/Zdjęcia/${item.name}.jpg`

											// path for Kraków
										} else if (city == 'KRAKÓW') {
											return `Kraków/Zdjęcia/${removeIcon(
												categories[item.catg]
											)}/${item.name}.jpg`

											// path for other cities in Poland
										} else {
											return `Polska/${region}/${capitalizedCity}/Zdjęcia/${item.name}.jpg`
										}
									}

									const newItem = {
										city: city,
										region: region,
										range: range,
										coor: item.coor,
										catg: item.catg,
										date: item.date,
										name: item.name,
										scale: item.scale,
										url: preparePath(),
									}
									if (item.top) {
										newItem.top = item.top
									}
									$citiesArray.push(newItem)
								})
							}
							// profile photo
							if (cityObj.coor && cityObj.date) {
								cityObj.date.forEach((year) => {
									function prepareProfilePath() {
										let path = ''
										if (range == ranges.MOUNTAINS) {
											path = `Góry/Zdjęcia/${capitalizeName(city)} ${year}.jpg`
										} else if (range == ranges.WORLD) {
											path = `Świat/Zdjęcia/${capitalizeName(city)}.jpg`
										} else if (range == ranges.POLAND) {
											path = `Polska/Zdjęcia/${capitalizeName(city)}.jpg`
										}
										return path
									}

									const newItem = {
										city: city,
										region: region,
										range: range,
										coor: cityObj.coor,
										scale: cityObj.scale,
										date: [year],
										name: [year],
										catg: enums.PROFILE,
										url: prepareProfilePath(),
									}
									$citiesArray.push(newItem)
								})
							}
						}
					}
				}
			}

			// @b filter data
			function filterData() {
				console.log('filterData()')
				// get data from original array
				$filteredData = $citiesArray

				// filter by range
				if ($selectRange.value !== enums.NONE) {
					if ($selectRegion.value == enums.ALL) {
						$filteredData = $filteredData.filter(
							(item) => $selectRange.value === item.range
						)
					} else if ($selectCity.value == enums.ALL) {
						$filteredData = $filteredData.filter(
							(item) => $selectRegion.value === item.region
						)
					} else {
						$filteredData = $citiesArray.filter(
							(item) => $selectCity.value === item.city
						)
					}
				}

				// filter by category filter
				if ($categoryFilter != enums.ALL) {
					$filteredData = $filteredData.filter((item) => {
						return item.catg == $categoryFilter
					})
				}
				// filter by date filter
				if ($dateFilter != enums.ALL) {
					$filteredData = $filteredData.filter((item) => {
						return item.date?.some((date) => date == Number($dateFilter))
					})
				}

				// sort data
				$filteredData = sortData($filteredData)

				// add id to filtered items
				$filteredData.forEach((item, index) => (item.id = index))
			}

			// @b sort data
			function sortData(array) {
				const categoryOrder = Object.values(categories)
				const namePriority = { zewnętrze: 1, wnętrze: 2, organy: 3 }

				array.sort((a, b) => {
					if (findRegion(a.city) < findRegion(b.city)) return -1
					if (findRegion(a.city) > findRegion(b.city)) return 1

					// sort by city
					if (a.city < b.city) return -1
					if (a.city > b.city) return 1

					// sort by category
					const categoryA = categoryOrder.indexOf(a.catg)
					const categoryB = categoryOrder.indexOf(b.catg)
					if (categoryA < categoryB) return -1
					if (categoryA > categoryB) return 1

					// ensure a.name and b.name are valid strings
					const nameA = typeof a.name === 'string' ? a.name : ''
					const nameB = typeof b.name === 'string' ? b.name : ''

					// sort by basilica name (everything before the last "/")
					const baseNameA = nameA.substring(0, nameA.lastIndexOf('/')) || nameA
					const baseNameB = nameB.substring(0, nameB.lastIndexOf('/')) || nameB

					if (baseNameA < baseNameB) return -1
					if (baseNameA > baseNameB) return 1

					// sort by name priority inside the same basilica
					const suffixA = nameA
						.substring(nameA.lastIndexOf('/') + 1)
						.toLowerCase()
					const suffixB = nameB
						.substring(nameB.lastIndexOf('/') + 1)
						.toLowerCase()

					const priorityA = namePriority[suffixA] || 4
					const priorityB = namePriority[suffixB] || 4

					return priorityA - priorityB
				})

				return array
			}

			// @b update data
			function updateData() {
				console.log('updateData()')
				filterData()
				prepareGallery()
				prepareMarkers()
				prepareRoutes()
				console.log($filteredData)
			}

			// @g Header

			// @b show hide menu
			function showHideMenu() {
				console.log('showHideMenu()')
				if ($isMobile) {
					const el = document.documentElement
					if (el.requestFullscreen) {
						el.requestFullscreen()
					} else if (el.webkitRequestFullscreen) {
						el.webkitRequestFullscreen()
					} else if (el.msRequestFullscreen) {
						el.msRequestFullscreen()
					}
				}

				$headerDiv.classList.toggle('hide')
				$footerDiv.classList.toggle('hide')
				$photoGroup.classList.toggle('top')
				$photoImage.classList.toggle('top')
				$gallery.classList.toggle('top')
				$isMenuOpen = !$isMenuOpen
			}

			// @b prepare view modes
			function prepareViewModes() {
				console.log('prepareViewModes()')
				createOption($selectViewMode, enums.MAP, labels.MAP, $viewMode)
				createOption(
					$selectViewMode,
					enums.MAP_GALLERY,
					labels.MAP_GALLERY,
					$viewMode
				)
				createOption($selectViewMode, enums.GALLERY, labels.GALLERY, $viewMode)
			}

			// @b prepare ranges
			function prepareRanges() {
				console.log(`prepareRanges()`)
				const ranges = Object.keys(data)

				$selectRange.innerHTML = ''
				const selectedRange = $isInitialRender ? findRange(startCity) : null

				createOption($selectRange, enums.NONE, labels.NONE)
				ranges.forEach((range) => {
					createOption($selectRange, range, range, selectedRange)
				})
				setLabels()
			}

			// @b prepare regions
			function prepareRegions() {
				console.log(`prepareRegions(${$selectRange.value})`)

				if ($selectRange.value == enums.NONE) {
					$selectRegion.innerHTML = ''
					$selectCity.innerHTML = ''
					return
				}

				$selectRegion.innerHTML = ''
				createOption($selectRegion, enums.ALL, labels.ALL)

				const selectedRegion = $isInitialRender ? findRegion(startCity) : null
				const regions = Object.keys(data[$selectRange.value])

				regions.forEach((region) => {
					createOption($selectRegion, region, region, selectedRegion)
				})
			}

			// @b prepare cities
			function prepareCities() {
				if (
					$selectRegion.value == enums.ALL ||
					$selectRegion.value == enums.EMPTY
				) {
					$selectCity.innerHTML = ''
					return
				}

				createOption($selectCity, enums.ALL, labels.ALL)
				const newCities = data[$selectRange.value][$selectRegion.value]
				console.log(`prepareCities(${$selectRegion.value})`)

				$selectCity.innerHTML = ''
				createOption($selectCity, enums.ALL, labels.ALL)

				const selectedCity = $isInitialRender ? startCity : null
				Object.keys(newCities).forEach((city) => {
					if (city !== 'coor' && city !== 'zoom') {
						createOption($selectCity, city, city, selectedCity)
					}
				})
				$isInitialRender = false
			}

			// @b prepare activities
			function prepareActivities() {
				console.log('prepareActivities()')
				$selectActivity.innerHTML = ''

				const selectedRange = $selectRange.value
				const allowed = allowedActivitiesByRange[selectedRange] || []

				allowed.forEach((activity_key) => {
					const activity_value = activities[activity_key]
					if (activity_value) {
						createOption(
							$selectActivity,
							activity_key,
							activity_value,
							$activityFilter
						)
					}
				})
			}

			// @b prepare categories
			function prepareCategories() {
				console.log('prepareCategories()')
				$selectCategory.innerHTML = ''

				const selectedRange = $selectRange.value
				const allowed = allowedCategoriesByRange[selectedRange] || []

				allowed.forEach((category_key) => {
					const category_value = categories[category_key]
					if (category_value) {
						createOption(
							$selectCategory,
							category_key,
							category_value,
							$categoryFilter
						)
					}
				})
			}

			// @b prepare dates
			function prepareDates() {
				console.log('prepareDates()')

				createOption($selectDate, enums.ALL, `📅 ${labels.ALL}`)
				createOption($selectDate, enums.PLAN, `📅 ${labels.PLAN}`)
				for (let year = YEAR; year >= 2004; year--) {
					createOption($selectDate, year, `📅 ${year}`, $dateFilter)
				}
			}

			// @b set labels
			function setLabels() {
				console.log(`setLabels()`)
				const range = $selectRange.value

				if (range == ranges.ROADS) {
					$labelRegion.textContent = 'Rodzaj:'
					$labelCity.textContent = 'Droga:'
				} else if (range == ranges.POLAND) {
					$labelRegion.textContent = 'Region:'
					$labelCity.textContent = 'Miasto:'
				} else if (range == ranges.WORLD) {
					$labelRegion.textContent = 'Państwo:'
					$labelCity.textContent = 'Miasto:'
				} else if (range == ranges.MOUNTAINS) {
					$labelRegion.textContent = 'Pasmo:'
					$labelCity.textContent = 'Szczyt:'
				} else if (range == enums.NONE) {
					$labelRegion.textContent = ''
					$labelCity.textContent = ''
				}
			}

			// @b set emblem
			function setEmblem() {
				console.log(`setEmblem(${$selectCity.value})`)

				if (
					$selectRange.value == ranges.ROADS ||
					$selectRange.value == ranges.MOUNTAINS ||
					$selectCity.value == enums.ALL ||
					$selectCity.value == ''
				) {
					$headerEmblem.classList.add('none')
				} else {
					$headerEmblem.classList.remove('none')

					const capitalizedCity = capitalizeName($selectCity.value)
					const capitalizedRegion = capitalizeName($selectRegion.value)

					let path = ''
					if ($selectRange.value == ranges.WORLD) {
						path = `Świat/${capitalizedRegion}/${capitalizedCity}/${capitalizedCity}.gif`
					} else if ($selectRange.value == ranges.POLAND) {
						path = `Polska/${capitalizedRegion}/${capitalizedCity}/${capitalizedCity}.gif`
					}
					$headerEmblem.setAttribute('src', path)
					$headerEmblem.setAttribute('alt', 'Herb')
				}
			}

			// @b set title
			function setTitle() {
				let title = ''
				if ($selectRange.value == enums.NONE) {
					title = 'PODRÓŻE'
				} else if ($selectRegion.value == enums.ALL) {
					title = $selectRange.value
				} else if ($selectCity.value == enums.ALL) {
					title = $selectRegion.value
				} else {
					title = $selectCity.value
				}
				document.title = title
				console.log(`setTitle(${title})`)
			}
			// @b set city
			function setCity() {
				console.log(`setCity(${$selectCity.value})`)
				setEmblem()
				setTitle()
				setMapView()
				updateData()
			}

			// @b set region
			function setRegion() {
				console.log(`setRegion(${$selectRegion.value})`)
				prepareCities()
				setEmblem()
				setTitle()
				setMapView()
				updateData()
			}

			// @b set range
			function setRange() {
				console.log(`setRange(${$selectRange.value})`)
				prepareActivities()
				prepareCategories()
				prepareRegions()
				prepareCities()
				setLabels()
				setEmblem()
				setTitle()
				setMapView()
				updateData()
			}

			// @b set view mode
			function setViewMode() {
				$viewMode = $selectViewMode.value
				console.log(`setViewMode(${$viewMode})`)

				// add class to gallery and background
				function classAdd(className) {
					$gallery.classList.add(className)
					$galleryBackground.classList.add(className)
				}
				// remove class from gallery and background
				function classRemove(className) {
					$gallery.classList.remove(className)
					$galleryBackground.classList.remove(className)
				}

				if ($viewMode == enums.MAP) {
					$isGalleryAndMap = false
					hidePhoto()
					classAdd('hide')
					setTimeout(() => {
						$isHiglightActive = true
						classRemove('hide')
						classRemove('show')
						classAdd('none')
					}, 400)
				} else if ($viewMode == enums.MAP_GALLERY) {
					$isGalleryAndMap = true
					classRemove('none')
					classAdd('show')
					classAdd('half')
					setTimeout(() => {
						$isHiglightActive = true
					}, 1000)
				} else if ($viewMode == enums.GALLERY) {
					$isGalleryAndMap = false
					$isHiglightActive = false
					classRemove('none')
					classRemove('half')
					classAdd('show')
				}
				setMapView()
			}

			// @b set activities
			function setActivities() {
				$activityFilter = $selectActivity.value
				console.log(`setActivity()`)
				prepareRoutes()
			}

			// @b set category
			function setCategory() {
				$categoryFilter = $selectCategory.value
				console.log(`setCategory()`)
				updateData()
			}

			// @b set dates
			function setDate() {
				$dateFilter = $selectDate.value
				console.log(`setDate(${$dateFilter})`)
				updateData()
			}

			// @g Gallery

			// @b prepare gallery
			function prepareGallery() {
				console.log('prepareGallery()')
				//clear gallery
				$gallery.innerHTML = ''
				// create imgs for filtered table
				$filteredData.forEach((item) => {
					let description = `${item.city}: ${item.name}`

					// gallery box
					const box = document.createElement('div')
					box.className = 'gallery_box'
					box.isClicked = false

					// gallery text
					const text = document.createElement('div')
					text.className = 'gallery_text'
					text.textContent = description
					text.setAttribute('id', item.id)
					text.addEventListener('click', (e) => showClickedPhoto(box)(e))
					text.addEventListener('mouseover', highlightMarker)
					text.addEventListener('mouseout', resetMarker)

					// gallery img
					const img = document.createElement('img')
					img.setAttribute('src', item.url)
					img.setAttribute('alt', description)
					img.setAttribute('id', item.id)
					img.addEventListener('click', (e) => showClickedPhoto(box)(e))
					img.addEventListener('mouseover', highlightMarker)
					img.addEventListener('mouseout', resetMarker)

					box.appendChild(img)
					box.appendChild(text)
					$gallery.appendChild(box)
					$photos.push(box)
				})
			}

			// @b show photo
			function showPhoto(imgID) {
				console.log(`showPhoto(${imgID})`)

				if ($isPhotoLoading) return
				$isPhotoLoading = true

				if (imgID == 0) {
					$photoPrevious.classList.add('none')
				} else {
					$photoPrevious.classList.remove('none')
				}

				if (imgID == $filteredData.length - 1) {
					$photoNext.classList.add('none')
				} else {
					$photoNext.classList.remove('none')
				}

				const image = document.getElementById(String(imgID))
				if (!image) {
					console.warn(`Brak elementu o ID ${imgID}`)
					$photoName.textContent = 'Nie znaleziono zdjęcia.'
					$isPhotoLoading = false
					return
				}
				$photoImage.setAttribute('src', image.src)

				let loadingTimeout = setTimeout(() => {
					$photoName.textContent = 'Ładowanie zdjęcia...'
				}, 500)

				console.log(`showPhoto(${imgID}) - start`)
				$photoImage.onload = () => {
					clearTimeout(loadingTimeout)
					$photoName.textContent = image.alt
					console.log(`showPhoto(${imgID}) - loaded`)
					$isPhotoLoading = false
				}

				$photoImage.onerror = () => {
					clearTimeout(loadingTimeout)
					$photoName.textContent = 'Zdjęcie jest niedostępne.'
					console.log(`showPhoto(${imgID}) - error`)
					$isPhotoLoading = false
				}
				$isPhotoOpen = true
			}

			// @b show clicked box
			const showClickedPhoto = (clickedPhoto) => (e) => {
				console.log(`showClickedPhoto(${clickedPhoto.isClicked})`)

				$photos.forEach((photo) => {
					if (photo !== clickedPhoto) {
						photo.isClicked = false
					}
				})

				if ($isMobile) {
					if (clickedPhoto.isClicked) {
						showSelectedPhoto(e)
						clickedPhoto.isClicked = false
					} else {
						clickedPhoto.isClicked = true
					}
				} else {
					showSelectedPhoto(e)
				}
			}

			// @b show clicked marker
			const showClickedMarker = (clickedMarker) => (e) => {
				console.log(`showClickedMarker(${clickedMarker.isClicked})`)

				$markers.forEach((marker) => {
					if (marker !== clickedMarker) {
						marker.isClicked = false
					}
				})

				if ($isMobile) {
					if (clickedMarker.isClicked) {
						showSelectedPhoto(e)
						clickedMarker.isClicked = false
					} else {
						clickedMarker.isClicked = true
					}
				} else {
					showSelectedPhoto(e)
				}
			}

			// @b show selected photo
			function showSelectedPhoto(e) {
				let imgID = e.target.id
				console.log(`showSelectedPhoto(${imgID})`)

				showPhoto(imgID)
				$index = imgID

				setTimeout(() => {
					$photo.classList.remove('none')
					$photo.classList.add('show')
				}, 100)
			}

			// @b show previous photo
			function showPreviousPhoto(e) {
				console.log('showPreviousPhoto()')

				e.stopPropagation()
				if ($isPhotoLoading) return
				if ($index > 0) {
					$index = parseInt($index) - 1
					showPhoto($index)
				}
			}

			// @b show next photo
			function showNextPhoto(e) {
				console.log('showNextPhoto()')

				e.stopPropagation()
				if ($isPhotoLoading) return
				if ($index < $filteredData.length - 1) {
					$index = parseInt($index) + 1
					showPhoto($index)
				}
			}

			// @b toggle presentation
			function togglePresentation(e) {
				console.log(`togglePresentation()`)

				if ($interval) {
					clearInterval($interval)
					$interval = null

					$photoPause.classList.add('none')
					$photoPlay.classList.remove('none')
				} else {
					showPhoto($index)

					$photo.classList.remove('none')
					$photo.classList.add('show')
					$photoPause.classList.remove('none')
					$photoPlay.classList.add('none')

					$interval = setInterval(() => {
						if ($isPhotoLoading) return
						if ($index < $filteredData.length - 1) {
							showNextPhoto(e)
						} else {
							$index = 0
							showPhoto($index)
						}
					}, 3000)
				}

				e?.stopPropagation()
			}

			// @b hide photo
			function hidePhoto() {
				console.log('hidePhoto()')
				clearInterval($interval)
				$interval = null

				$isPhotoOpen = false
				$photoName.textContent = ''
				$photo.classList.add('hide')
				setTimeout(() => {
					$photo.classList.add('none')
					$photo.classList.remove('show')
					$photo.classList.remove('hide')
					$photoPlay.classList.remove('none')
					$photoPause.classList.add('none')
				}, 400)
			}

			// @g Map

			// @b prepare map
			function prepareMap() {
				console.log('prepareMap()')
				// leaflet map view
				$map = L.map('map')
				// add leaflet openstreetmap
				L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
					attribution:
						'Map data from <a href="https://www.openstreetmap.org/">OpenStreetMap</a>',
					maxZoom: 18,
				}).addTo($map)

				// remove zoom controls
				const zoomControl = L.control.zoom()
				zoomControl.addTo($map)
				$map.removeControl(zoomControl)

				// keyboard disabled
				$map.keyboard.disable()

				// getting coordinates from map
				if (mapActive) {
					$map.on('click', (e) => {
						const lat = e.latlng.lat.toFixed(7)
						const lng = e.latlng.lng.toFixed(7)
						console.log(`${lat},${lng}`)
						// alert(`${lat},${lng}`)
					})
				}
			}

			// @b set map view
			function setMapView() {
				console.log(`setMapView()`)

				if ($selectRange.value == enums.NONE) {
					$map.setView(...setCoor([46.8, 9.3], 5))
					return
				}

				if ($selectRegion.value == enums.ALL) {
					if ($selectRange.value == ranges.MOUNTAINS) {
						$map.setView(...setCoor([50.05, 19.25], 8))
					} else if ($selectRange.value == ranges.POLAND) {
						$map.setView(...setCoor([52.05, 19.25], 7))
					} else if ($selectRange.value == ranges.ROADS) {
						$map.setView(...setCoor([52.05, 19.25], 7))
					} else if ($selectRange.value == ranges.WORLD) {
						$map.setView(...setCoor([46.8, 9.3], 6))
					} else {
						$map.setView(...setCoor([0, 0], 6))
					}
				} else if ($selectCity.value == enums.ALL) {
					const region = data[$selectRange.value][$selectRegion.value]
					$map.setView(...setCoor(region.coor, region.zoom))
				} else {
					const city =
						data[$selectRange.value][$selectRegion.value][$selectCity.value]
					$map.setView(...setCoor(city.coor, city.zoom))
				}
			}

			// @b set coordinates
			function setCoor(coor, zoom) {
				if (!$map || !$map._loaded) {
					return [coor, zoom]
				}

				if ($isMobile) {
					zoom -= 1
				}

				const mapZoom = $map.getZoom()
				const mapPoint = $map.latLngToContainerPoint(coor)
				const scale = Math.pow(2, zoom - mapZoom)
				const width = window.innerWidth
				const shiftX = width / 4 / scale
				const headerHeight = $headerDiv.offsetHeight || 0
				const shiftY = headerHeight / 2 / scale
				const newX = mapPoint.x - shiftX
				const newY = mapPoint.y - shiftY

				if ($isGalleryAndMap) {
					const newCoor = $map.containerPointToLatLng([newX, newY])
					return [newCoor, zoom]
				} else {
					const newCoor = $map.containerPointToLatLng([mapPoint.x, newY])
					return [newCoor, zoom]
				}
			}

			// @g Markers

			// @b prepare markers
			function prepareMarkers() {
				console.log('prepareMarkers()')

				// remove all markers from map
				$markers.forEach((marker) => $map.removeLayer(marker))
				// remove all markers from table
				$markers = []
				// create new markers
				$filteredData.forEach((item) => {
					createMarker(item)
				})
				// add zoom listener
				addZoomToMakers()
			}

			// @b create marker
			function createMarker({ coor, city, catg, name, url, id, top, scale }) {
				// icon
				const zoom = $map.getZoom()
				const icon = L.icon({
					iconUrl: url.replace(/(\/)([^/]+)\.([^/.]+)$/, '$1webp/$2.webp'),
					iconSize: setZoom(zoom, scale),
					iconAnchor: setAnchor(zoom, scale),
					className: `marker marker-${catg.toLowerCase()}`,
				})

				let tooltipContent = `${city}:\n${name}`

				const tooltipOptions = {
					className: 'marker-tooltip',
					direction: 'bottom',
					offset: [0, 42],
					opacity: 0.8,
				}

				// marker
				const marker = L.marker(coor, { icon: icon }).addTo($map)
				marker.id = id
				marker.catg = catg
				marker.scale = scale
				marker.isClicked = false
				marker.bindTooltip(tooltipContent, tooltipOptions)
				marker.on('mouseover', highlightMarker)
				marker.on('mouseout', resetMarker)
				marker.on('click', (e) => showClickedMarker(marker)(e))

				if (top) {
					marker.top = top
					marker.setZIndexOffset(1)
				}
				$markers.push(marker)
			}

			// @b add zoom to markers
			function addZoomToMakers() {
				$map.on('zoomend', () => {
					$markers.forEach((marker) => {
						updateMarkerSize(marker)
					})
				})
			}

			// @b highlight marker
			function highlightMarker(e) {
				if ($isHiglightActive) {
					const id = e.target.id
					const marker = $markers[id]
					marker.setZIndexOffset(100)
					updateMarkerSize(marker, 2)
				}
			}

			// @b reset marker
			function resetMarker(e) {
				const id = e.target.id
				const marker = $markers[id]
				if (marker.top) {
					marker.setZIndexOffset(1)
				} else {
					marker.setZIndexOffset(0)
				}
				updateMarkerSize(marker)
			}

			// @b update marker size
			function updateMarkerSize(marker, value) {
				const zoom = $map.getZoom()
				const icon = marker.options.icon
				let scale = marker.scale
				let factor = 1
				if (value) {
					factor = (value * 12) / zoom
					scale = 1
				}
				icon.options.iconSize = setZoom(zoom * factor, scale)
				icon.options.iconAnchor = setAnchor(zoom * factor, scale)
				marker.setIcon(icon)
			}

			// @b set zoom of marker
			function setZoom(zoom, scale = 1) {
				const size = Math.pow(zoom, 2) * 0.15 * scale
				return [size, size]
			}

			// @b set anchor of marker
			function setAnchor(zoom, scale = 1) {
				const size = Math.pow(zoom, 2) * 0.15 * scale
				return [size * 0.5, size * 0.5]
			}

			// @g Routes

			// @b prepare routes
			function prepareRoutes() {
				console.log('prepareRoutes()')

				// Clear previous layers
				$routeLayers.forEach((layer) => $map.removeLayer(layer))
				$routeLayers = []

				// Total distance of visible routes
				let totalLength = 0

				// Sort routes
				const sortedRoutes = [...routes].sort((a, b) => {
					const isAPlanned = a.year > YEAR
					const isBPlanned = b.year > YEAR

					if (isAPlanned && !isBPlanned) return -1
					if (!isAPlanned && isBPlanned) return 1

					return a.year - b.year
				})

				// Loop through all routes
				sortedRoutes.forEach((route) => {
					// Skip route if it doesn't match the active filters
					if (shouldRouteSkip(route)) return

					// Create route polyline and interactive hitbox layer
					const { polyline, hitbox } = createRouteLayer(route)

					// Add both layers to the map layer collection
					$routeLayers.push(polyline, hitbox)
					// Update the total distance with the current route's length
					totalLength += route.length
				})
				setDistance(totalLength)
			}

			// @b should route skip
			function shouldRouteSkip(route) {
				// Exclude routes not matching selected activity
				if (
					$activityFilter !== enums.ALL &&
					$activityFilter !== route.activity
				) {
					return true
				}

				// Skip routes that don't match selected range
				if (
					$selectRange.value !== enums.NONE &&
					$selectRange.value !== route.range
				) {
					return true
				}

				if (route.range === ranges.ROADS) {
					// For road routes, extract info from name
					const roadName = route.name.split(' ')[2]
					const roadLanes = route.name.split(' ')[4]

					const roadCategoryMap = {
						A: 'Ekspresowe',
						S: 'Ekspresowe',
						DK: 'Krajowe',
						DW: 'Wojewódzkie',
						K: 'Krakowskie',
					}

					// Determine road category
					const roadKey = Object.keys(roadCategoryMap).find((key) =>
						roadName.startsWith(key)
					)
					const roadCategory = roadCategoryMap[roadKey]

					// Filter by region
					if (
						$selectRegion.value !== enums.ALL &&
						$selectRegion.value !== roadCategory
					) {
						return true
					}

					// Filter by road name
					if (
						$selectCity.value !== enums.ALL &&
						$selectCity.value !== enums.EMPTY &&
						$selectCity.value !== roadName
					) {
						return true
					}

					// Filter by year
					if ($dateFilter === enums.PLAN) {
						if (route.year <= YEAR) return true
					} else if (
						$dateFilter !== enums.ALL &&
						route.year > parseInt($dateFilter)
					) {
						return true
					}
				} else {
					// For non-road routes: filter by year
					if ($dateFilter === enums.PLAN) {
						if (route.year <= YEAR) return true
					} else if (
						$dateFilter !== enums.ALL &&
						route.year !== parseInt($dateFilter)
					) {
						return true
					}
				}
				return false
			}

			// @b get color for route
			function getColorForRoute(year) {
				const minYear = 2004
				const maxYear = 2025

				// Clamp year
				const clampedYear = Math.max(minYear, Math.min(maxYear, year))

				// Normalize to 0–1
				const ratio = (clampedYear - minYear) / (maxYear - minYear)

				// Map to 0–255 (intensity of blue)
				const blue = Math.round(ratio * 255)
				const hex = blue.toString(16).padStart(2, '0')

				return `#0000${hex}`
			}

			// @b create route layer
			function createRouteLayer(route) {
				// Default styles
				const defaultColor = 'black'
				const activeColor = 'dodgerblue'
				const planColor = 'steelblue'

				const defaultWeight = 2
				const activeWeight = 6

				// Activity categories
				const primaryActivities = [
					'cycling',
					'europe_transport_boat',
					'europe_cycling',
				]
				const secondaryActivities = [
					'walking',
					'europe_walking',
					'downhill_skiing',
				]

				let routeColor = defaultColor
				let routeWeight = defaultWeight
				let routeName = `${route.icon} ${route.name}`
				let toggled = false

				// Roads: style and weight based on years and lanes
				if (route.range === 'DROGI') {
					const lanes = route.name.split(' ')[4]

					routeName = route.name
					routeColor = getColorForRoute(route.year)
					routeWeight = lanes == 3 ? 5 : lanes == 2 ? 4 : lanes == 1 ? 3 : 2
				} else {
					// Other routes: color by activity
					if (primaryActivities.includes(route.activity)) {
						routeColor = '#444'
					} else if (secondaryActivities.includes(route.activity)) {
						routeColor = '#666'
					}
				}

				if (route.year > YEAR || route.year == 0) {
					routeColor = planColor
				}

				// Main visible polyline
				const polyline = L.polyline(route.coords, {
					color: routeColor,
					weight: routeWeight,
				}).addTo($map)

				// Invisible hitbox for better interaction
				const hitbox = L.polyline(route.coords, {
					color: 'transparent',
					pane: 'shadowPane',
					weight: 20,
					opacity: 0,
				}).addTo($map)

				// Style updates
				const updateStyle = () => {
					polyline.setStyle({
						color: toggled ? activeColor : routeColor,
						weight: toggled ? activeWeight : routeWeight,
					})
					if (toggled) polyline.bringToFront()
				}

				// Highlight on hover
				const highlight = () => {
					if (!toggled) {
						polyline.setStyle({ weight: activeWeight })
						polyline.bringToFront()
					}
				}

				// Reset style on mouse out
				const resetHighlight = () => {
					if (!toggled) {
						polyline.setStyle({ weight: routeWeight })
					}
				}

				// Toggle popup and active style
				const toggleRoute = () => {
					toggled = !toggled
					updateStyle()

					if (toggled) {
						polyline.openPopup()
					} else {
						polyline.closePopup()
					}
				}

				// Bind events
				hitbox.on('mouseover', highlight)
				hitbox.on('mouseout', resetHighlight)
				hitbox.on('touchstart', toggleRoute)
				hitbox.on('click', toggleRoute)

				// Add popup
				polyline.bindPopup(routeName)

				// Return polyline and hitbox
				return {
					polyline,
					hitbox,
				}
			}

			// @b set distance
			function setDistance(distance) {
				const distanceFormatted = distance.toLocaleString('pl-PL', {
					minimumFractionDigits: 0,
					maximumFractionDigits: 0,
				})
				$footerDistance.textContent = `${distanceFormatted} km`
			}

			// @g Tools

			// @b find range
			function findRange(city) {
				for (const range in data) {
					for (const region in data[range]) {
						if (city in data[range][region]) {
							return range
						} else {
							return ranges.POLAND
						}
					}
				}
			}

			// @b find region
			function findRegion(city) {
				for (const range in data) {
					for (const region in data[range]) {
						if (city in data[range][region]) {
							return region
						}
					}
				}
			}

			// @b remove icon
			function removeIcon(text) {
				return text?.split(' ').slice(1).join(' ') || text
			}

			// @b capitalize name
			function capitalizeName(city) {
				return city
					.toLowerCase()
					.replace(/(?:^|\s|-)([a-ż])/g, (match) => match.toUpperCase())
			}

			// @b create option
			function createOption(parent, value, textContent, selected) {
				const option = document.createElement('option')
				option.classList.add('header_option')
				option.value = value
				option.textContent = textContent ? textContent : value
				if (selected) {
					if (value == selected) {
						option.setAttribute('selected', 'selected')
					}
				}
				parent.appendChild(option)
			}

			// @b map regions
			function mapRegions(data) {
				const newData = {}

				for (const [regionName, regionData] of Object.entries(data)) {
					const { coor, zoom, ...data } = regionData
					const newCities = {}

					for (const [cityName, cityData] of Object.entries(data)) {
						const { abbr, ...rest } = cityData
						newCities[abbr] = rest
					}

					newData[regionName] = { coor, zoom, ...newCities }
				}

				return newData
			}

			// @b debug
			function debug(item) {
				console.log('--->')
				console.log(item)
				console.log('<---')
			}
		</script>
	</body>
</html>
